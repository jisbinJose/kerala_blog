{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="blog-post">
        <h1 class="mb-3">{{ translated_title|default:blog.title }}</h1>
        
        <div class="blog-meta mb-4">
            <p class="text-muted">
                By <a href="{% url 'blogger-detail' blog.author.pk %}" class="text-decoration-none">{{ blog.author }}</a>
                on {{ blog.post_date|date:"F j, Y" }}
            </p>
            
            {% if user.is_authenticated and blog.author.user == user %}
            <div class="mb-3">
                <a href="{% url 'blog-update' blog.pk %}" class="btn btn-outline-primary">
                    <i class="fas fa-edit"></i> Edit Blog
                </a>
                <a href="{% url 'blog-delete' blog.pk %}" class="btn btn-outline-danger">
                    <i class="fas fa-trash"></i> Delete Blog
                </a>
            </div>
            {% endif %}
        </div>

        {% if blog.image %}
        <div class="blog-image mb-4">
            <img src="{{ blog.image.url }}" class="img-fluid rounded" alt="{{ blog.title }}">
        </div>
        {% endif %}

        <div class="blog-content mb-4">
            <div class="d-flex mb-3">
                <button id="ttsButton" class="btn btn-outline-primary me-2">
                    <i class="fas fa-volume-up"></i> Listen
                </button>
                
                <div class="btn-group ms-2">
                    {% if target_language == 'ml' %}
                        <a href="{{ request.path }}" class="btn btn-outline-secondary">
                            <i class="fas fa-language"></i> Show Original (English)
                        </a>
                    {% elif target_language == 'en' %}
                        <a href="{{ request.path }}" class="btn btn-outline-secondary">
                            <i class="fas fa-language"></i> Show Original (Malayalam)
                        </a>
                    {% else %}
                        <a href="{{ request.path }}?translate=1&to=ml" class="btn btn-outline-secondary">
                            <i class="fas fa-language"></i> Translate to Malayalam
                        </a>
                        <a href="{{ request.path }}?translate=1&to=en" class="btn btn-outline-secondary">
                            <i class="fas fa-language"></i> Translate to English
                        </a>
                    {% endif %}
                </div>
            </div>
            
            <audio id="ttsAudio" style="display: none;"></audio>
            <div id="blog-content">
                {% if translated_content %}
                    {{ translated_content|linebreaks }}
                {% else %}
                    {{ blog.content|linebreaks }}
                {% endif %}
            </div>
        </div>

        <hr>

        <div id="comments" class="comments-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Comments ({{ blog.comments.count }})</h3>
                {% if user.is_authenticated %}
                <a href="{% url 'blog-comment' blog.pk %}" class="btn btn-primary">
                    <i class="fas fa-comment"></i> Add Comment
                </a>
                {% endif %}
            </div>

            {% for comment in blog.comments.all %}
            <div class="card mb-3">
                <div class="card-body">
                    <p class="card-text">{{ comment.text }}</p>
                    <p class="card-text">
                        <small class="text-muted">
                            By <a href="{% url 'blogger-detail' comment.author.blogger.pk %}" class="text-decoration-none">{{ comment.author }}</a>
                            on {{ comment.post_date|date:"F j, Y" }}
                        </small>
                    </p>
                </div>
            </div>
            {% empty %}
            <p>No comments yet. Be the first to comment!</p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const button = document.getElementById('ttsButton');
const content = document.getElementById('blog-content');
const audio = document.getElementById('ttsAudio');
let isPlaying = false;

function createGoogleTTSUrl(text) {
    // Determine language for TTS
    {% if target_language == 'ml' %}
    const ttsLang = 'ml';
    {% elif target_language == 'en' %}
    const ttsLang = 'en';
    {% else %}
    // Try to detect if content has Malayalam characters
    const hasMalayalam = /[\u0D00-\u0D7F]/.test(text);
    const ttsLang = hasMalayalam ? 'ml' : 'en';
    {% endif %}
    
    return `https://translate.google.com/translate_tts?ie=UTF-8&tl=${ttsLang}&client=tw-ob&q=${encodeURIComponent(text)}`;
}

function splitTextIntoChunks(text, maxLength = 200) {
    const words = text.split(' ');
    const chunks = [];
    let currentChunk = '';

    for (const word of words) {
        if ((currentChunk + ' ' + word).length <= maxLength) {
            currentChunk += (currentChunk ? ' ' : '') + word;
        } else {
            chunks.push(currentChunk);
            currentChunk = word;
        }
    }
    if (currentChunk) {
        chunks.push(currentChunk);
    }
    return chunks;
}

let currentChunkIndex = 0;
let textChunks = [];

button.addEventListener('click', function() {
    if (isPlaying) {
        audio.pause();
        audio.currentTime = 0;
        isPlaying = false;
        currentChunkIndex = 0;
        button.innerHTML = '<i class="fas fa-volume-up"></i> Listen';
        return;
    }

    const text = content.textContent;
    textChunks = splitTextIntoChunks(text);
    currentChunkIndex = 0;
    playNextChunk();
});

function playNextChunk() {
    if (currentChunkIndex >= textChunks.length) {
        isPlaying = false;
        button.innerHTML = '<i class="fas fa-volume-up"></i> Listen';
        return;
    }

    const url = createGoogleTTSUrl(textChunks[currentChunkIndex]);
    audio.src = url;
    
    audio.onplay = function() {
        isPlaying = true;
        button.innerHTML = '<i class="fas fa-stop"></i> Stop';
    };

    audio.onended = function() {
        currentChunkIndex++;
        if (isPlaying) {
            playNextChunk();
        }
    };

    audio.onerror = function() {
        console.error('Error playing audio');
        isPlaying = false;
        button.innerHTML = '<i class="fas fa-volume-up"></i> Listen';
    };

    audio.play().catch(function(error) {
        console.error('Error starting playback:', error);
        isPlaying = false;
        button.innerHTML = '<i class="fas fa-volume-up"></i> Listen';
    });
}

// Clean up when leaving the page
window.addEventListener('beforeunload', function() {
    if (isPlaying) {
        audio.pause();
    }
});

// If the URL has a #comments hash, scroll to comments
if (window.location.hash === '#comments') {
    document.getElementById('comments').scrollIntoView();
}
</script>
{% endblock %}
